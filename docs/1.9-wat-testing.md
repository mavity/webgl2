# WebGL2 WAT Testing Spec

This file is the authoritative specification for exposing compiled shader WASM and WAT text for testing purposes. It is intentionally minimal and prescriptive: only the host exports and the module-level JS primitives described here are part of this spec. No helper functions, no context prototype extensions, and no normalization rules are included.

## 1. Purpose

Allow tests to retrieve:
- the raw compiled shader WASM bytes, and
- the textual WAT representation of that module

so tests can assert exact, reviewed code-generation results.

## 2. Host exports

Implement the following exports in Rust (C ABI). Use multi-value returns `(u32, u32)` for `(ptr, len)` where available. If multi-value is not supported in a target environment, use a single `u64` return packing pointer and length (low 32 = ptr, high 32 = len).

2.1 wasm_ctx_get_program_wasm_ref

Preferred signature:

    pub extern "C" fn wasm_ctx_get_program_wasm_ref(ctx: u32, program: u32, shader_type: u32) -> (u32, u32);

Packed fallback signature:

    pub extern "C" fn wasm_ctx_get_program_wasm_ref(ctx: u32, program: u32, shader_type: u32) -> u64;

Behavior:
- On success return `(ptr, len)` pointing to WASM bytes owned by Rust.
- On missing module or failure return `(0, 0)` (or `0n` for u64 fallback).
- The pointer is ephemeral; callers must copy bytes synchronously and must not retain pointers.

2.2 wasm_ctx_get_program_wat_ref

Preferred signature:

    pub extern "C" fn wasm_ctx_get_program_wat_ref(ctx: u32, program: u32, shader_type: u32) -> (u32, u32);

Packed fallback signature:

    pub extern "C" fn wasm_ctx_get_program_wat_ref(ctx: u32, program: u32, shader_type: u32) -> u64;

Behavior:
- On success return `(ptr, len)` pointing to a UTF-8 encoded WAT string owned by Rust.
- On missing module or failure return `(0, 0)`.
- The pointer is ephemeral; callers must copy/decode synchronously and must not retain pointers.

Implementation: the WAT string must be produced on demand (for example via `wasmprinter::print_bytes(&wasm_bytes)`), and Rust may reuse or free that memory at any later time; no persistent caching is mandated by this spec.

## 3. JavaScript primitives (module-level)

Provide these plain, synchronous JS functions. They accept primitive handles and return raw data. They are NOT methods on any WebGL2 context prototype.

3.1 getShaderModule

Signature:

    function getShaderModule(ctxHandle: number, programHandle: number, shaderType: number): Uint8Array | null

Behavior:
- Call `wasm_ctx_get_program_wasm_ref(ctxHandle, programHandle, shaderType)`.
- If the result is `(0, 0)` return `null`.
- Otherwise copy `len` bytes starting at `ptr` from the module memory into a new `Uint8Array` and return it.
- Do not retain or reuse the returned pointer.

3.2 getShaderWat

Signature:

    function getShaderWat(ctxHandle: number, programHandle: number, shaderType: number): string | null

Behavior:
- Call `wasm_ctx_get_program_wat_ref(ctxHandle, programHandle, shaderType)`.
- If the result is `(0, 0)` return `null`.
- Otherwise copy `len` bytes starting at `ptr` and decode as UTF-8 (via `TextDecoder`) and return the exact string produced by Rust. The string must be returned verbatim; the runtime must not normalize, strip, or otherwise alter the WAT text.
- Do not retain or reuse the returned pointer.

JS note: if the host uses packed `u64` fallback, JS must unpack the `BigInt` into `ptr` and `len` before copying.

## 4. Test & snapshot policy

- Tests must compare against the exact values returned by these primitives. WAT comparisons must be exact string equality unless a test intentionally applies its own transformation (that transformation must be documented in the test).
- Snapshot files are checked into source control and must be updated explicitly in a reviewed PR when WAT output intentionally changes. Do not auto-commit generated WAT during test runs or CI.

## 5. Safety & constraints

- The host-provided pointers are ephemeral. The embedder/JS must copy or decode immediately. Holding on to pointers or reading them later is undefined.
- Implementations must avoid introducing non-deterministic elements into WAT output (timestamps, machine-local metadata) unless those are explicitly part of the tested artifact and are accounted for in snapshot update policy.

## 6. Change management

- Any change to codegen or the WAT generator that affects WAT text must be accompanied by explicit snapshot updates in a PR with review. This ensures test expectations remain intentional and auditable.

