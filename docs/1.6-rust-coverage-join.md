# Coverage synchronised lock-free algo

1.  **Retry Loop**: Loop 30 times.
2.  **Read & Assess (The "Superiority Check")**:
    *   Read `raw_coverage.json`.
    *   Calculate `myStartTime = Date.now() - (process.uptime() * 1000)`.
    *   **Case A: File Missing**:
        *   We are the first. `baseData = {}`, `baseTimestamp = Date.now()`.
    *   **Case B: PPID Match**:
        *   We belong to this run.
        *   `baseData = file.data`.
        *   `baseTimestamp = file.timestamp` (**Retain original timestamp**).
    *   **Case C: PPID Mismatch**:
        *   **Check**: Is `file.timestamp > myStartTime`?
            *   **YES**: The file belongs to a run that started *after* me. I am an old straggler. **BAIL** (Do not write, do not retry).
            *   **NO**: The file belongs to an older run. I am the new run. **Overwrite**.
                *   `baseData = {}`.
                *   `baseTimestamp = Date.now()` (New timestamp for new run).
3.  **Merge**: Merge `currentCoverage` into `baseData`.
4.  **Pre-Write Check (CSMA/CA)**:
    *   Check file on disk. If changed (content/hash mismatch from Step 2), **Backoff & Retry**.
5.  **Write**:
    *   Write `{ ppid: process.ppid, timestamp: baseTimestamp, data: mergedData }`.
6.  **Delay**: Random wait (100-400ms).
7.  **Verify**:
    *   Read file back.
    *   **Check 1**: If `file.ppid != process.ppid` -> **BAIL** (New run took over).
    *   **Check 2**: If `file.timestamp != baseTimestamp` -> **BAIL** (Shouldn't happen if PPID matches, but implies state corruption).
    *   **Check 3 (Semantic)**: Are all my reported lines present in the file with counts `>=` what I wrote?
        *   **Yes**: Success.
        *   **No**: Retry from Step 1.

This covers all constraints:
*   **Optimistic**: No OS locks.
*   **Collision Avoidance**: Pre-write check.
*   **Verification**: Post-write semantic check.
*   **Run Isolation**: PPID check.
*   **Zombie Protection**: Timestamp "superiority" check.
